<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Cube Color</title>
	<link rel="stylesheet" href="style.css">

	<script src="build/tracking-min.js"></script>

	<script>
		cont = 0;
		sequencia = []; //Sequência de cores geradas pelo jogo
		timer = 0;
		corReconhecida = 0;
		ultimaCor = ''; //última cor reconhecida
		vetorCoresReconhecidas = []; //Cores reconhecidas pela camera
		pontuacao = 0;
		numCores = 2; //Número de cores que serão geradas
		//cores = ['orange', 'blue', 'red', 'green']; //Cores que serão geradas
		cores = ['blue', 'red', 'green', 'magenta']; //Cores que serão geradas
		corComparada = 0
		tempoEspera = 1000;

		function Sequencia(){ //Função que gera a sequencia de cores
			Zerar();
			sequencia = [];
			vetorCoresReconhecidas = [];

			for(i = 0; i < numCores; i++){
				var sorteada = cores[(Math.floor(Math.random() * 4))];
				sequencia.push(sorteada);
			}
			timer = 0;
			Exibir();
		}

		function ProximoNivel(){
			var sorteada = cores[(Math.floor(Math.random() * 4))];
			sequencia.push(sorteada);
			vetorCoresReconhecidas = [];
			ultimaCor = '';
			timer = 0;
			corReconhecida = 0;
			corComparada = 0
			numCores = 2;
			Exibir();
		}

		function Zerar() { //Zera os contadores e o vetor das cores mostrada pelo jogador na rodada anterior.
			corReconhecida = 0;
			corComparada = 0
			pontuacao = 0;
			tempoEspera = 1000;
			vetorCoresReconhecidas = [];
			sequencia = [];
			ultimaCor = '';
			document.getElementById("lida").innerHTML = "";
			document.getElementById("revelar").innerHTML = "";
			document.getElementById("pontos").innerHTML = "0";
		}

		function Exibir(){
			document.getElementById('mostrar-sequencia').hidden = false;
			
			if(cont < sequencia.length){
				if(timer % 2 == 0){ //Não exibe nenhuma cor
					document.getElementById('color').className = "alpha";
					document.getElementById('numero').innerHTML = "";

				} else { //Exibe a cor da sequência
					document.getElementById('color').className = sequencia[cont];
					document.getElementById('numero').innerHTML = cont + 1;
					cont++;			
				}

				timer++;
				if(timer <= sequencia.length * 2){
					t = setTimeout(function(){ Exibir() }, tempoEspera);
				}
				
			} else {
				document.getElementById('color').className = 'alpha';
				document.getElementById('mostrar-sequencia').hidden = true;
				document.getElementById('comecar').disabled = true;
				cont = 0;

				if(tempoEspera > 100){
					tempoEspera = tempoEspera - 100; //Reduz o tempo de exibição das cores
				}
				Start(); //Inicia o jogo e a camera
			}
			
		}


		//Verificar se a cor exibida é a mesma da cor gerada.
		function Verificar(){
			if(vetorCoresReconhecidas[corReconhecida] != "yellow" && vetorCoresReconhecidas[corReconhecida] != sequencia[corComparada]){
				alert("Você perdeu.");
				document.getElementById("lida").innerHTML = "Cores lidas: " + vetorCoresReconhecidas;
				document.getElementById("revelar").innerHTML = "Squência gerada: " + sequencia;				
				document.getElementById("comecar").disabled = false;
				document.getElementById("btnProximoNivel").disabled = true;
				tracking.track('#video').stop();

				return false;

			} else if(vetorCoresReconhecidas.length == sequencia.length){
				numCores += 1;
				pontuacao += sequencia.length + 1; //Caso acerte todas, ganha mais a quantidade de cores do nível atual.
				AtualizarPontuacao();
				document.getElementById("btnProximoNivel").disabled = false;
				tracking.track('#video').stop();

				//alert("Parabéns, você Ganhou!");
				//return false;
				
			} else if(vetorCoresReconhecidas[corReconhecida] != "yellow"){
				corComparada++;
				corReconhecida++;
				pontuacao++; //Ganha 1 ponto para cada cor certa
				AtualizarPontuacao();
			}
		}

		function AtualizarPontuacao(){
			document.getElementById("pontos").innerHTML = pontuacao; //Atualizar pontuacao
		}

	</script>
</head>
<body>
	<div class="title">
		<p>Color Cube</p>
	</div>

	<div class="topo">
		<span class="spanPontos">Pontos:</span>
		<div class="pontuacao" id="pontuacao">

			<span class="pontos" id="pontos">0</span>
		</div>
		<br>
		<button OnClick="Sequencia()" id="comecar">Começar</button>
		<button OnClick="ProximoNivel()" id="btnProximoNivel" disabled>Próximo Nível</button>
		

		

		<div class="texto"><span id="revelar" class="gerada"></span></div>

		<div class="texto"><span id="lida" class="lida"></span></div>
	</div>


	<div class="container">
		<video id="video" class="video" width="600" height="450" preload autoplay loop muted></video>
		<canvas id="canvas" class="canvas" width="600" height="450"></canvas>
	</div>

	<div id="mostrar-sequencia" class="show-color" hidden>
		<canvas id="color" class="" width="200" height="200"></canvas>
		<span id="numero" class="numero"></span>
	</div>
	
	

	<script>
	function Start() {
		if(sequencia.length == 0){
			alert("Primero você deve gerar a sequência.");
			return false;
		}

		tracking.ColorTracker.registerColor('yellow', function(r, g, b) {
			if (r > 140 && g > 120 && g < 240 && g < r  && b < g && b > 30 && b < 125) {
				return true;
			}
			return false;
		});

		tracking.ColorTracker.registerColor('green', function(r, g, b) {
			if (r < 120 && g > 160 && b < 120 && b > 60) {
				return true;
			}
			return false;
		});

		tracking.ColorTracker.registerColor('red', function(r, g, b) {
			if (r > 110 && g < 45 && b < 45) {
				return true;
			}
			return false;
		});

		tracking.ColorTracker.registerColor('orange', function(r, g, b) {
			if (r > 170 && g < 165 && g > 60 && b < 50) {
				return true;
			}
			return false;
		});

		tracking.ColorTracker.registerColor('blue', function(r, g, b) {
			if (r < 30 && g < 90 && b > 70) {
				return true;
			}
			return false;
		});

		tracking.ColorTracker.registerColor('magenta', function(r, g, b) {
			if (r > 130 && g < 75 && b < 150 && b > 80) {
				return true;
			}
			return false;
		});

		
		tracking.ColorTracker.registerColor('black', function(r, g, b) {
			if (r < 30 && g < 30 && b < 30) {
				return true;
			}
			return false;
		});

		
		tracking.ColorTracker.registerColor('white', function(r, g, b) {
			if (r > 150 && g > 150 && b > 150) {
				return true;
			}
			return false;
		});

		var video = document.getElementById('video');
		var canvas = document.getElementById('canvas');
		var context = canvas.getContext('2d');

		
		//Adiciona novar cores para serem rastreadas
		var color = new tracking.ColorTracker(['yellow', 'blue', 'red', 'green', 'magenta']);

		tracking.track('#video', color, { camera: true });

		color.on('track', function(event) {
			context.clearRect(0, 0, canvas.width, canvas.height);

			//Rect é um objeto retornado quando uma cor é identidicada
			event.data.forEach(function(rect) {
				context.strokeStyle = rect.color;
				context.strokeRect(rect.x, rect.y, rect.width, rect.height);

				//Caso a cor identificada não seja igual a última ele adiciona novamento no vetor
				if(rect.color != ultimaCor && rect.color != "yellow"){
					vetorCoresReconhecidas.push(rect.color);
					Verificar(); //Função que diz se acertou ou errou				
				}
				ultimaCor = rect.color;

			});
		});

	};
	</script>
</body>
</html>