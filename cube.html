<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Cube Color</title>
	<link rel="stylesheet" href="style.css">

	<script src="build/tracking-min.js"></script>

	<script>
		cont = 0;
		sequencia = [];
		timer = 0;
		contRec = 0;
		ultimaCor = '';

		function Sequencia(){
			Zerar();
			var cores = ['orange', 'blue', 'red', 'green'];
			sequencia = [];
			reconhecido = [];

			for(i = 0; i < 5; i++){
				var sorteada = cores[(Math.floor(Math.random() * 4))];

				sequencia.push(sorteada);
			}
			cont = 0;
			
			timer = 0;
			Exibir();
		}

		function Zerar() {
			contRec = 0;
			cont = 0;
			reconhecido = [];
			sequencia = [];
			ultimaCor = '';
			document.getElementById("lida").innerHTML = "";
			document.getElementById("revelar").innerHTML = "";
		}

		function Exibir(){
			document.getElementById('mostrar-sequencia').hidden = false;
			if(cont < sequencia.length){
				document.getElementById('color').className = sequencia[cont];
				document.getElementById('numero').innerHTML = cont + 1;
				cont++;

				timer++;
				if(timer <= 5){
					t = setTimeout(function(){ Exibir() }, 1000);
				}

			} else {
				document.getElementById('color').className = 'alpha';
				document.getElementById('mostrar-sequencia').hidden = true;
				cont = 0;
			}
		}

		function Verificar(){
				if(reconhecido[contRec] != "yellow" && reconhecido[contRec] != sequencia[cont]){
					alert("Você perdeu.");
					document.getElementById("revelar").innerHTML = "Squência gerada: " + sequencia;

					tracking.track('#video').stop();

					return false;

				} else if(reconhecido.length == sequencia.length){
					alert("Parabéns, você Ganhou!");

					tracking.track('#video').stop();

					return false;
					
				} else if(reconhecido[contRec] != "yellow"){
					cont++;
					contRec++;
				}
			}

		function Close(){
			timer = 6;
			document.getElementById('mostrar-sequencia').hidden = true;
		}
	</script>
</head>
<body>
	<div class="title">
		<p>Cube</p>
	</div>

	<div class="container">
		<video id="video" width="600" height="450" preload autoplay loop muted></video>
		<canvas id="canvas" width="600" height="450"></canvas>
	</div>

	<div id="mostrar-sequencia" class="show-color" onclick="Close();" hidden>
		<canvas id="color" class="" width="250" height="250"></canvas>
		<span id="numero" class="numero"></span>
	</div>

	<div class="texto"><span id="lida" class="lida"></span></div>

	<div class="texto"><span id="revelar" class="lida"></span></div>
	
	<aside>
		<button OnClick="Start();">Start</button>

		<button OnClick="Sequencia()">Sequencia</button>

	</aside>


	<script>
	function Start() {
		if(sequencia.length == -1){
			alert("Primero você deve gerar a sequência.");
			return false;
		}

		/*
		tracking.ColorTracker.registerColor('amarelo', function(r, g, b) {
			if (r > 130 && g > 160 && b < 95) {
				return true;
			}
			return false;
		}); */

		tracking.ColorTracker.registerColor('green', function(r, g, b) {
			if ((r < 80 && g > 125 && b < 80) || (r > 100 && r < 180 && (g - 50) > b  && b > 80 && g > 230) ) {
				return true;
			}
			return false;
		});

		
		tracking.ColorTracker.registerColor('darkgreen', function(r, g, b) {
			if (r < 30 && g < 70 && b < 30) {
				return true;
			}
			return false;
		});

		tracking.ColorTracker.registerColor('red', function(r, g, b) {
			if (r > 100 && g < 20 && b < 30) {
				return true;
			}
			return false;
		});

		
		tracking.ColorTracker.registerColor('darkred', function(r, g, b) {
			if (r < 135 && g < 30 && b < 30) {
				return true;
			}
			return false;
		});

		tracking.ColorTracker.registerColor('orange', function(r, g, b) {
			if (r > 150 && g < 75 && b < 75) {
				return true;
			}
			return false;
		});

		tracking.ColorTracker.registerColor('blue', function(r, g, b) {
			if (r < 30 && g < 30 && b > 30) {
				return true;
			}
			return false;
		});

		
		tracking.ColorTracker.registerColor('black', function(r, g, b) {
			if (r < 30 && g < 30 && b < 30) {
				return true;
			}
			return false;
		});

		
		tracking.ColorTracker.registerColor('white', function(r, g, b) {
			if (r > 150 && g > 150 && b > 150) {
				return true;
			}
			return false;
		});

		var video = document.getElementById('video');
		var canvas = document.getElementById('canvas');
		var context = canvas.getContext('2d');
;
		
		//Adiciona novar cores para serem rastreadas
		var color = new tracking.ColorTracker(['yellow', 'orange', 'blue', 'red', 'green']);

		tracking.track('#video', color, { camera: true });

		color.on('track', function(event) {
			context.clearRect(0, 0, canvas.width, canvas.height);

			//Rect é um objeto retornaco quando uma cor é identidicada
			event.data.forEach(function(rect) {
				context.strokeStyle = rect.color;
				context.strokeRect(rect.x, rect.y, rect.width, rect.height);

				//Caso a cor identificada não seja igual a última ele adiciona novamento no vetor
				if(rect.color != ultimaCor && rect.color != "yellow"){
					reconhecido.push(rect.color);
					document.getElementById("lida").innerHTML = reconhecido;
					Verificar();					
				}
				ultimaCor = rect.color;

			});
		});

	};
	</script>
</body>
</html>